const SHEET_ID = '1Uzvrp-GVYFlJZht9uOawiHJS3vV3Ub6MGmsVfS0P-so';

function doPost(e) {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  
  try {
    const data = JSON.parse(e.postData.contents);
    const action = data.action;
    const output = ContentService.createTextOutput().setMimeType(ContentService.MimeType.JSON);
    
    // ① 業務報告の追加
    if (action === 'addReport') {
      const reportSheet = ss.getSheetByName('業務報告');
      const depositSheet = ss.getSheetByName('前払い管理');
      const newId = Utilities.getUuid();
      
      let paidStatus = '未入金';
      let autoDeducted = false;
      let insufficientBalance = false;
      let currentDeposit = 0;
      const sales = Number(data.totalSales) || 0;
      const customerName = data.customerName;
      
      // 前払い残高から自動引き落とし
      if (depositSheet && customerName && sales > 0) {
        const dValues = depositSheet.getDataRange().getValues();
        for (let i = 1; i < dValues.length; i++) {
          if (dValues[i][0] === customerName) {
            currentDeposit = Number(dValues[i][1]) || 0;
            if (currentDeposit >= sales) {
              depositSheet.getRange(i + 1, 2).setValue(currentDeposit - sales);
              paidStatus = '入金済'; 
              autoDeducted = true;
            } else if (currentDeposit > 0) {
              insufficientBalance = true;
            }
            break;
          }
        }
      }

      reportSheet.appendRow([
        newId,
        data.date,
        data.staff,
        data.customerPhone,
        data.customerName,
        data.services,
        sales,
        data.staffShare,
        paidStatus
      ]);
      
      return output.setContent(JSON.stringify({ 
        success: true, 
        id: newId, 
        autoDeducted: autoDeducted, 
        insufficientBalance: insufficientBalance,
        currentDeposit: currentDeposit
      }));
    }
    
    // ② 入金状況の更新
    if (action === 'updatePaidStatus') {
      const sheet = ss.getSheetByName('業務報告');
      const targetId = data.id;
      const newStatus = data.isPaid ? '入金済' : '未入金';
      
      const values = sheet.getDataRange().getValues();
      for (let i = 1; i < values.length; i++) {
        if (values[i][0] === targetId) {
          sheet.getRange(i + 1, 9).setValue(newStatus);
          return output.setContent(JSON.stringify({ success: true }));
        }
      }
      return output.setContent(JSON.stringify({ success: false, message: 'IDが見つかりません' }));
    }

    // ③ ブラックリストの追加
    if (action === 'addBlacklist') {
      const sheet = ss.getSheetByName('ブラックリスト');
      // [電話番号, お客様名, 登録理由, 登録日時]
      sheet.appendRow([
        data.phone,
        data.name,
        data.reason,
        new Date().toLocaleString('ja-JP')
      ]);
      return output.setContent(JSON.stringify({ success: true }));
    }

    // ⑤ お客様の新規追加（前払い用）
    if (action === 'addCustomer') {
      let sheet = ss.getSheetByName("前払い管理");
      if (!sheet) {
        sheet = ss.insertSheet("前払い管理");
        sheet.appendRow(["お客様名", "現在の残高"]); 
      }
      
      const customerName = data.customerName;
      const values = sheet.getDataRange().getValues();
      let exists = false;
      for (let i = 1; i < values.length; i++) {
        if (values[i][0] === customerName) {
          exists = true;
          break;
        }
      }
      
      if (!exists) {
        sheet.appendRow([customerName, 0]);
      }
      
      return output.setContent(JSON.stringify({ success: true }));
    }

    // ⑥ チャージ・利用（残高更新）
    if (action === 'updateDeposit') {
      const sheet = ss.getSheetByName("前払い管理");
      if (!sheet) {
        return output.setContent(JSON.stringify({ success: false, message: '前払い管理シートがありません' }));
      }
      
      const customerName = data.customerName;
      const amount = Number(data.amount) || 0;
      
      const values = sheet.getDataRange().getValues();
      let customerRowIndex = -1;
      let currentBalance = 0;
      
      for (let i = 1; i < values.length; i++) {
        if (values[i][0] === customerName) {
          customerRowIndex = i + 1; // 1ベース
          currentBalance = Number(values[i][1]) || 0;
          break;
        }
      }
      
      if (customerRowIndex !== -1) {
        // 既存顧客の残高を更新
        const newBalance = currentBalance + amount;
        sheet.getRange(customerRowIndex, 2).setValue(newBalance);
      } else {
        // 顧客が存在しない場合は新規追加
        sheet.appendRow([customerName, amount]);
      }
      
      return output.setContent(JSON.stringify({ success: true }));
    }
    
    return output.setContent(JSON.stringify({ success: false, message: 'Invalid action' }));
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({ success: false, error: error.toString() })).setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  const action = e.parameter.action;
  const output = ContentService.createTextOutput().setMimeType(ContentService.MimeType.JSON);

  try {
    // 業務報告一覧の取得
    if (action === 'getReports') {
      const sheet = ss.getSheetByName('業務報告');
      const data = sheet.getDataRange().getValues();
      if (data.length > 0) data.shift(); // ヘッダーを1行目として削除
      return output.setContent(JSON.stringify({ success: true, data: data }));
    }

    // ⑧ 顧客情報（電話番号→名前のマップ）とブラックリストの取得
    if (action === 'getCustomerInfo') {
      const result = { success: true, customers: {}, blacklistedPhones: [] };
      
      // まず業務報告から顧客マップを作成（新しいものが上書きされるように上から下へ）
      const reportSheet = ss.getSheetByName('業務報告');
      if (reportSheet) {
        const reportData = reportSheet.getDataRange().getValues();
        if (reportData.length > 1) {
          for (let i = 1; i < reportData.length; i++) {
            const phone = String(reportData[i][3]).trim();
            const name = String(reportData[i][4]).trim();
            if (phone && name && name !== '名無し') {
              result.customers[phone] = name;
            }
          }
        }
      }

      // 既存の前払い管理の顧客も名前だけ拾っておく（電話番号がないので業務報告優先）
      
      // ブラックリスト取得
      const blSheet = ss.getSheetByName('ブラックリスト');
      if (blSheet) {
        const blData = blSheet.getDataRange().getValues();
        if (blData.length > 1) {
          for (let i = 1; i < blData.length; i++) {
            const phone = String(blData[i][0]).trim();
            if (phone) {
              result.blacklistedPhones.push(phone);
            }
          }
        }
      }

      return output.setContent(JSON.stringify(result));
    }

    // ⑦ 残高データの取得
    if (action === 'getDeposits') {
      const sheet = ss.getSheetByName("前払い管理");
      if (!sheet) {
        return output.setContent(JSON.stringify({ success: false, message: '前払い管理シートがありません' }));
      }
      
      const data = sheet.getDataRange().getValues();
      const deposits = {};
      if (data.length > 1) { 
        for (let i = 1; i < data.length; i++) {
          const name = data[i][0];
          const balance = data[i][1];
          if (name) {
            deposits[name] = Number(balance) || 0;
          }
        }
      }
      
      return output.setContent(JSON.stringify({ success: true, deposits: deposits }));
    }
    
    return output.setContent(JSON.stringify({ success: false, message: 'Invalid action' }));
  } catch (error) {
    return output.setContent(JSON.stringify({ success: false, error: error.toString() }));
  }
}
