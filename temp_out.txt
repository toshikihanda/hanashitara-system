'use client';

import { useState, useEffect } from 'react';

// â‘ å–å¾—ãƒ‡ãƒ¼ã‚¿ã®å‹å®šç¾©
interface ReportData {
    id: string; // GASã§ç”Ÿæˆã—ãŸUUID
    date: string;
    staff: string;
    customerName: string;
    customerPhone: string;
    services: string;
    totalSales: number;
    staffShare: number;
    isPaid: boolean;
    daysPending: number; // æœªå…¥é‡‘æ—¥æ•°ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§è¨ˆç®—ï¼‰
}

export default function AdminDashboard() {
    const [reports, setReports] = useState<ReportData[]>([]);
    const [isLoading, setIsLoading] = useState(true);
    const [errorText, setErrorText] = useState('');

    // ã‚¿ãƒ–çŠ¶æ…‹ç®¡ç†
    const [activeTab, setActiveTab] = useState<'sales' | 'staff' | 'deposit'>('sales');
    // å‰æ‰•ã„ãƒ‡ãƒã‚¸ãƒƒãƒˆçŠ¶æ…‹
    const [deposits, setDeposits] = useState<Record<string, number>>({});

    type CustomerSortOption = 'deposit' | 'paid_desc' | 'registered_asc' | 'registered_desc' | 'name_asc' | 'number_asc';
    const [customerSortBy, setCustomerSortBy] = useState<CustomerSortOption>('deposit');

    // ã‚³ãƒ”ãƒ¼å®Œäº†ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤ºç”¨
    const [copiedId, setCopiedId] = useState<string | null>(null);

    // ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆä¿æŒç”¨
    const [blacklistedPhones, setBlacklistedPhones] = useState<string[]>([]);

    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzopMne7Ga8ZruWAf3xvAP7WQFvQ-Uau09qsmG2K6-Mcs7xfrXXl1Ev4GmLHpOcgTwj/exec';

    // â‘¡åˆå›èª­ã¿è¾¼ã¿æ™‚ã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹
    useEffect(() => {
        fetchReports();
        fetchBlacklist();
        fetchDeposits();
    }, []);

    const fetchDeposits = async () => {
        try {
            const res = await fetch(`${GAS_URL}?action=getDeposits`);
            const json = await res.json();
            if (json.success) {
                setDeposits(json.deposits || {});
            }
        } catch (err) {
            console.error('ãƒ‡ãƒã‚¸ãƒƒãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', err);
        }
    };

    const fetchBlacklist = async () => {
        try {
            const res = await fetch(`${GAS_URL}?action=getBlacklistPhones`);
            const json = await res.json();
            if (json.success) {
                setBlacklistedPhones(json.phones || []);
            }
        } catch (err) {
            console.error('ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', err);
        }
    };

    const fetchReports = async () => {
        setIsLoading(true);
        try {
            // GASã® doGet å´ã‚’å©ã (action=getReports)
            const res = await fetch(`${GAS_URL}?action=getReports`);
            const json = await res.json();

            if (json.success) {
                // å–å¾—ã—ãŸäºŒæ¬¡å…ƒé…åˆ—ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼ã«æ•´å½¢ï¼‹æ—¥æ•°ã®è¨ˆç®—
                const today = new Date();
                const formattedData: ReportData[] = json.data.map((row: any[]) => {
                    // A:ID(0), B:æ—¥ä»˜(1), C:ã‚¹ã‚¿ãƒƒãƒ•(2), D:é¡§å®¢é›»è©±(3), E:é¡§å®¢å(4), 
                    // F:æä¾›ã‚µãƒ¼ãƒ“ã‚¹(5), G:ç·å£²ä¸Š(6), H:ã‚¹ã‚¿ãƒƒãƒ•å ±é…¬(7), I:å…¥é‡‘æ¸ˆ(8)

                    // æœªå…¥é‡‘æ—¥æ•°ã®è¨ˆç®—
                    let days = 0;
                    const isPaidStatus = row[8] === 'å…¥é‡‘æ¸ˆ' || row[8] === true || row[8] === 'TRUE';
                    if (!isPaidStatus && row[1]) {
                        const reportDate = new Date(row[1]);
                        const diffTime = Math.abs(today.getTime() - reportDate.getTime());
                        days = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                    }

                    return {
                        id: row[0],
                        date: row[1],
                        staff: row[2],
                        customerPhone: row[3],
                        customerName: row[4],
                        services: row[5],
                        totalSales: Number(row[6]) || 0,
                        staffShare: Number(row[7]) || 0,
                        isPaid: isPaidStatus,
                        daysPending: days
                    };
                });

                // æ—¥ä»˜ã®æ–°ã—ã„é †ã«ä¸¦ã³æ›¿ãˆï¼ˆé™é †ï¼‰
                formattedData.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
                setReports(formattedData);
            } else {
                setErrorText('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + json.message);
            }
        } catch (err) {
            console.error(err);
            setErrorText('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
        } finally {
            setIsLoading(false);
        }
    };

    const togglePaidStatus = async (id: string, currentPaid: boolean) => {
        const newPaidStatus = !currentPaid;
        // ç”»é¢ä¸Šã®è¦‹ãŸç›®ã‚’å³åº§ã«åˆ‡ã‚Šæ›¿ãˆã‚‹
        setReports(reports.map(r => r.id === id ? { ...r, isPaid: newPaidStatus } : r));

        try {
            // GASã¸é€šä¿¡ã—ã¦ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’æ›´æ–°
            await fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    action: 'updatePaidStatus',
                    id: id,
                    isPaid: newPaidStatus
                }),
            });
        } catch (error) {
            console.error('æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
            alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å…ƒã®çŠ¶æ…‹ã«æˆ»ã‚Šã¾ã™ã€‚');
            // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ç”»é¢ã‚’å…ƒã«æˆ»ã™
            setReports(reports.map(r => r.id === id ? { ...r, isPaid: currentPaid } : r));
        }
    };

    const handleAddBlacklist = async (phone: string, name: string) => {
        const reason = window.prompt(`${name}ã•ã‚“ (${phone}) ã‚’ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã«ç™»éŒ²ã™ã‚‹ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆã‚¤ã‚¿ã‚ºãƒ©ã€æœªæ‰•ã„ç­‰ï¼‰`);
        if (!reason) return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«

        // å³åº§ã«UIã¸åæ˜ 
        setBlacklistedPhones(prev => [...prev, phone]);

        try {
            await fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({ action: 'addBlacklist', phone, name, reason }),
            });
            alert('ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã«ç™»éŒ²ã—ã¾ã—ãŸã€‚');
        } catch (err) {
            console.error('ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆç™»éŒ²ã‚¨ãƒ©ãƒ¼:', err);
            alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ç½®ã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
            // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å…ƒã«æˆ»ã™
            setBlacklistedPhones(prev => prev.filter(p => p !== phone));
        }
    };

    // ç£ä¿ƒæ–‡ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã™ã‚‹é–¢æ•°
    const handleCopyRemind = (report: ReportData) => {
        const text = `${report.customerName} æ§˜
        
ã„ã¤ã‚‚ãƒãƒŠã‚·ã‚¿ãƒ©.comã‚’ã”åˆ©ç”¨ã„ãŸã ãã€èª ã«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚
${new Date(report.date).toLocaleDateString('ja-JP')} ã«ã”åˆ©ç”¨ã„ãŸã ãã¾ã—ãŸä¸‹è¨˜ã‚µãƒ¼ãƒ“ã‚¹ã«ã¤ãã¾ã—ã¦ã€ç¾åœ¨ã”å…¥é‡‘ã®ç¢ºèªãŒã¨ã‚Œã¦ãŠã‚Šã¾ã›ã‚“ã€‚

ã€ã”åˆ©ç”¨å†…å®¹ã€‘: ${report.services}
ã€ã”è«‹æ±‚é‡‘é¡ã€‘: Â¥${report.totalSales.toLocaleString()}-

ãŠæ‰‹æ•°ã‚’ãŠã‹ã‘ã„ãŸã—ã¾ã™ãŒã€æŒ‡å®šã®å£åº§ã¾ã§ã”å…¥é‡‘ã‚’ãŠé¡˜ã„ç”³ã—ä¸Šã’ã¾ã™ã€‚
è¡Œãé•ã„ã§æ—¢ã«ãŠæŒ¯è¾¼æ¸ˆã¿ã®å ´åˆã¯ã€ä½•å’ã”å®¹èµ¦ãã ã•ã„ã¾ã›ã€‚

å¼•ãç¶šãã€ãƒãƒŠã‚·ã‚¿ãƒ©.comã‚’ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚`;

        navigator.clipboard.writeText(text).then(() => {
            setCopiedId(report.id);
            setTimeout(() => setCopiedId(null), 2000); // 2ç§’å¾Œã«ã€Œã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€ã®è¡¨ç¤ºã‚’æ¶ˆã™
        }).catch(err => {
            console.error('ã‚³ãƒ”ãƒ¼å¤±æ•—:', err);
            alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        });
    };

    // ---- ãƒ•ã‚§ãƒ¼ã‚º4: é›†è¨ˆãƒ­ã‚¸ãƒƒã‚¯ ----
    const currentYear = new Date().getFullYear();
    const currentMonthStr = `${currentYear}-${String(new Date().getMonth() + 1).padStart(2, '0')}`;

    // 1. å¹´é–“åˆè¨ˆï¼ˆå½“å¹´ï¼‰
    const yearReports = reports.filter(r => new Date(r.date).getFullYear() === currentYear);
    const totalYearSales = yearReports.reduce((sum, r) => sum + r.totalSales, 0);
    const totalYearProfit = yearReports.reduce((sum, r) => sum + (r.totalSales - r.staffShare), 0);

    // 2. ä»Šæœˆåˆ†åˆè¨ˆ
    const monthReports = reports.filter(r => {
        const d = new Date(r.date);
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}` === currentMonthStr;
    });
    const totalMonthSales = monthReports.reduce((sum, r) => sum + r.totalSales, 0);
    const totalMonthProfit = monthReports.reduce((sum, r) => sum + (r.totalSales - r.staffShare), 0);

    // 3. å…¨ã¦ã®æœªå…¥é‡‘é¡
    const totalUnpaid = reports.filter(r => !r.isPaid).reduce((sum, r) => sum + r.totalSales, 0);

    // 4. ã‚¹ã‚¿ãƒƒãƒ•åˆ¥é›†è¨ˆï¼ˆä»Šæœˆï¼‰
    const staffStatsMap = new Map<string, { sales: number, share: number }>();
    monthReports.forEach(r => {
        const current = staffStatsMap.get(r.staff) || { sales: 0, share: 0 };
        staffStatsMap.set(r.staff, {
            sales: current.sales + r.totalSales,
            share: current.share + r.staffShare
        });
    });
    const staffStats = Array.from(staffStatsMap.entries())
        .map(([name, stats]) => ({ name, ...stats }))
        .sort((a, b) => b.sales - a.sales);

    // ãƒ•ã‚§ãƒ¼ã‚º5: ãŠå®¢æ§˜ä¸€è¦§ã®ç”Ÿæˆï¼ˆãƒ‡ãƒã‚¸ãƒƒãƒˆåˆ©ç”¨è€…å„ªå…ˆï¼‹ãã®ä»–ã®ã‚½ãƒ¼ãƒˆï¼‰
    const customerMap = new Map<string, { totalPaid: number, registeredDate: string }>();
    reports.forEach(r => {
        if (r.customerName) {
            const current = customerMap.get(r.customerName) || {
                totalPaid: 0,
                registeredDate: r.date
            };
            if (r.isPaid) {
                current.totalPaid += r.totalSales;
            }
            if (new Date(r.date) < new Date(current.registeredDate)) {
                current.registeredDate = r.date;
            }
            customerMap.set(r.customerName, current);
        }
    });

    Object.keys(deposits).forEach(name => {
        if (!customerMap.has(name)) {
            customerMap.set(name, { totalPaid: 0, registeredDate: new Date().toISOString() });
        }
    });

    // ç™»éŒ²æ—¥ãƒ™ãƒ¼ã‚¹ã§ãŠå®¢æ§˜ç•ªå·ï¼ˆé€£ç•ªï¼‰ã‚’å‰²ã‚Šå½“ã¦ã‚‹ãŸã‚ã«ä¸€æ™‚ã‚½ãƒ¼ãƒˆ
    const allCustomers = Array.from(customerMap.entries())
        .map(([name, data]) => ({ name, ...data }))
        .sort((a, b) => new Date(a.registeredDate).getTime() - new Date(b.registeredDate).getTime());

    const customerList = allCustomers.map((customer, index) => {
        const balance = deposits[customer.name] || 0;
        return {
            name: customer.name,
            balance,
            totalPaid: customer.totalPaid,
            registeredDate: customer.registeredDate,
            customerNumber: index + 1
        };
    }).sort((a, b) => {
        if (customerSortBy === 'deposit') {
            if (a.balance > 0 && b.balance === 0) return -1;
            if (a.balance === 0 && b.balance > 0) return 1;
            if (a.totalPaid !== b.totalPaid) return b.totalPaid - a.totalPaid;
            return a.name.localeCompare(b.name, 'ja');
        }
        if (customerSortBy === 'paid_desc') {
            return b.totalPaid - a.totalPaid;
        }
        if (customerSortBy === 'registered_asc') {
            return new Date(a.registeredDate).getTime() - new Date(b.registeredDate).getTime();
        }
        if (customerSortBy === 'registered_desc') {
            return new Date(b.registeredDate).getTime() - new Date(a.registeredDate).getTime();
        }
        if (customerSortBy === 'number_asc') {
            return a.customerNumber - b.customerNumber;
        }
        if (customerSortBy === 'name_asc') {
            return a.name.localeCompare(b.name, 'ja');
        }
        return 0;
    });

    return (
        <div className="p-6 max-w-6xl mx-auto space-y-8 pb-32">
            <header className="flex flex-col md:flex-row justify-between items-start md:items-end border-b pb-4 gap-4">
                <div>
                    <h1 className="text-2xl font-bold text-gray-900">ã‚ªãƒ¼ãƒŠãƒ¼ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
                    <p className="text-sm text-gray-500 mt-1">å£²ä¸Šç®¡ç†ãƒ»ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†</p>
                </div>
            </header>

            {/* ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */}
            <div className="flex gap-4 border-b border-gray-100 mb-6">
                <button
                    onClick={() => setActiveTab('sales')}
                    className={`pb-3 px-4 text-sm font-bold transition-colors border-b-2 ${activeTab === 'sales' ? 'border-gray-900 text-gray-900' : 'border-transparent text-gray-400 hover:text-gray-700 hover:border-gray-300'
                        }`}
                >
                    ğŸ“Š å£²ä¸Šãƒ»å…¥é‡‘ç®¡ç†
                </button>
                <button
                    onClick={() => setActiveTab('staff')}
                    className={`pb-3 px-4 text-sm font-bold transition-colors border-b-2 ${activeTab === 'staff' ? 'border-gray-900 text-gray-900' : 'border-transparent text-gray-400 hover:text-gray-700 hover:border-gray-300'
                        }`}
                >
                    ğŸ‘¥ ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†
                </button>
                <button
                    onClick={() => setActiveTab('deposit')}
                    className={`pb-3 px-4 text-sm font-bold transition-colors border-b-2 ${activeTab === 'deposit' ? 'border-gray-900 text-gray-900' : 'border-transparent text-gray-400 hover:text-gray-700 hover:border-gray-300'
                        }`}
                >
                    ğŸ’³ ãŠå®¢æ§˜ç®¡ç†
                </button>
            </div>

            {activeTab === 'sales' && (
                <>
                    {/* é›†è¨ˆã‚µãƒãƒªãƒ¼è¡¨ç¤º (ãƒ•ã‚§ãƒ¼ã‚º4) */}
                    <section className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        {/* ç·åˆã‚µãƒãƒªãƒ¼ */}
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col gap-4">
                            <h2 className="font-bold text-gray-800 border-b border-gray-100 pb-2">ã‚µãƒãƒªãƒ¼ ({currentMonthStr.replace('-', 'å¹´')}æœˆ)</h2>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <p className="text-xs text-gray-500 mb-1 font-medium">ä»Šæœˆã®ç·å£²ä¸Š</p>
                                    <p className="text-xl font-bold text-gray-900">Â¥{totalMonthSales.toLocaleString()}</p>
                                </div>
                                <div>
                                    <p className="text-xs text-blue-600 mb-1 font-bold">âœ¨ ã‚ªãƒ¼ãƒŠãƒ¼åˆ©ç›Š</p>
                                    <p className="text-xl font-bold text-blue-600">Â¥{totalMonthProfit.toLocaleString()}</p>
                                </div>
                                <div className="pt-2 border-t border-gray-100 col-span-2">
                                    <p className="text-xs text-gray-500 mb-1 font-medium">ç¾åœ¨ã®æœªå…¥é‡‘ç·é¡</p>
                                    <p className="text-lg font-bold text-red-500">Â¥{totalUnpaid.toLocaleString()}</p>
                                </div>
                            </div>
                        </div>

                        {/* å¹´é–“ã‚µãƒãƒªãƒ¼ */}
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col gap-4 relative overflow-hidden">
                            <div className="absolute top-0 right-0 p-4 opacity-5 text-6xl">ğŸ“ˆ</div>
                            <h2 className="font-bold border-b border-gray-100 pb-2 text-gray-800">ç¢ºå®šç”³å‘Šç”¨ ({currentYear}å¹´ ç´¯è¨ˆ)</h2>
                            <div className="flex-1 flex flex-col justify-center gap-4 relative z-10">
                                <div>
                                    <p className="text-xs text-gray-500 mb-1 font-medium">å¹´é–“ ç·å£²ä¸Š</p>
                                    <p className="text-2xl font-bold text-gray-900">Â¥{totalYearSales.toLocaleString()}</p>
                                </div>
                                <div>
                                    <p className="text-xs text-blue-600 mb-1 font-bold">å¹´é–“ ã‚ªãƒ¼ãƒŠãƒ¼ç´”åˆ©ç›Š</p>
                                    <p className="text-xl font-bold text-blue-600">Â¥{totalYearProfit.toLocaleString()}</p>
                                </div>
                            </div>
                        </div>

                        {/* ã‚¹ã‚¿ãƒƒãƒ•åˆ¥å®Ÿç¸¾ï¼ˆä»Šæœˆï¼‰ */}
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col h-full max-h-[250px] overflow-hidden">
                            <h2 className="font-bold text-gray-800 border-b border-gray-100 pb-2 mb-3">ã‚¹ã‚¿ãƒƒãƒ•åˆ¥å®Ÿç¸¾ ({currentMonthStr.replace('-', 'å¹´')}æœˆ)</h2>
                            <div className="overflow-y-auto pr-2 space-y-3">
                                {staffStats.length === 0 ? (
                                    <p className="text-sm text-gray-400 text-center py-4">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
                                ) : (
                                    <ul className="space-y-3">
                                        {staffStats.map(s => (
                                            <li key={s.name} className="flex justify-between items-center text-sm border-b border-gray-50 pb-2 last:border-0">
                                                <span className="font-semibold text-gray-700">{s.name}</span>
                                                <div className="text-right">
                                                    <p className="text-gray-900 font-medium">å£²ä¸Š: Â¥{s.sales.toLocaleString()}</p>
                                                    <p className="text-[11px] text-gray-400 mt-0.5">å ±é…¬: Â¥{s.share.toLocaleString()}</p>
                                                </div>
                                            </li>
                                        ))}
                                    </ul>
                                )}
                            </div>
                        </div>
                    </section>

                    {/* å ±å‘Šãƒ‡ãƒ¼ã‚¿ä¸€è¦§ãƒ»å…¥é‡‘ãƒã‚§ãƒƒã‚¯ */}
                    <section className="bg-white rounded-xl shadow-sm border overflow-hidden">
                        <div className="px-6 py-4 border-b flex justify-between items-center bg-gray-50/50">
                            <h2 className="font-semibold text-gray-800">æœ€æ–°ã®æ¥­å‹™å ±å‘Š / å…¥é‡‘ç¢ºèª</h2>
                        </div>
                        <div className="overflow-x-auto relative">

                            {/* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã¨ã‚¨ãƒ©ãƒ¼è¡¨ç¤º */}
                            {isLoading && (
                                <div className="absolute inset-0 bg-white/70 flex justify-center items-center z-10 backdrop-blur-sm">
                                    <span className="text-gray-500 font-medium animate-pulse">ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</span>
                                </div>
                            )}
                            {errorText && (
                                <div className="p-4 bg-red-50 text-red-600 text-sm border-b font-medium">
                                    {errorText}
                                </div>
                            )}

                            <table className="w-full text-sm text-left">
                                <thead className="bg-gray-50 text-gray-600 border-b">
                                    <tr>
                                        <th className="px-6 py-3 font-medium">æ—¥ä»˜</th>
                                        <th className="px-6 py-3 font-medium">ã‚¹ã‚¿ãƒƒãƒ•</th>
                                        <th className="px-6 py-3 font-medium">ãŠå®¢æ§˜å (é›»è©±) / ã‚µãƒ¼ãƒ“ã‚¹</th>
                                        <th className="px-6 py-3 font-medium text-right">å£²ä¸Šé¡</th>
                                        <th className="px-6 py-3 font-medium text-right">ã‚¹ã‚¿ãƒƒãƒ•å ±é…¬</th>
                                        <th className="px-6 py-3 font-medium text-center">å…¥é‡‘çŠ¶æ³</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100">
                                    {reports.length === 0 && !isLoading && !errorText && (
                                        <tr>
                                            <td colSpan={6} className="px-6 py-8 text-center text-gray-400">
                                                å ±å‘Šãƒ‡ãƒ¼ã‚¿ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“
                                            </td>
                                        </tr>
                                    )}
                                    {reports.map((report) => (
                                        <tr key={report.id} className={`hover:bg-gray-50/50 transition-colors ${!report.isPaid && report.daysPending >= 3 ? 'bg-red-50/30' : ''}`}>
                                            <td className="px-6 py-4 text-gray-600 whitespace-nowrap">{new Date(report.date).toLocaleDateString('ja-JP')}</td>
                                            <td className="px-6 py-4 font-medium text-gray-900">{report.staff}</td>
                                            <td className="px-6 py-4 text-gray-600">
                                                <div className="font-medium text-gray-800 flex items-center gap-2">
                                                    {report.customerName}
                                                    {blacklistedPhones.includes(report.customerPhone) && (
                                                        <span className="text-[10px] bg-red-100 text-red-700 px-1.5 py-0.5 rounded font-bold border border-red-200">ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆå—è¨ºæ‹’å¦</span>
                                                    )}
                                                </div>
                                                <div className="text-xs text-gray-400 mt-0.5 flex items-center gap-2">
                                                    {report.customerPhone}
                                                    {!blacklistedPhones.includes(report.customerPhone) && (
                                                        <button
                                                            onClick={() => handleAddBlacklist(report.customerPhone, report.customerName)}
                                                            className="text-[10px] text-gray-400 hover:text-red-500 underline transition-colors"
                                                        >
                                                            ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã«ç™»éŒ²
                                                        </button>
                                                    )}
                                                </div>
                                                <div className="text-[11px] bg-blue-50 text-blue-700 px-2 py-0.5 rounded inline-block mt-1">{report.services}</div>
                                            </td>
                                            <td className="px-6 py-4 text-right font-medium text-gray-900">Â¥{report.totalSales.toLocaleString()}</td>
                                            <td className="px-6 py-4 text-right text-gray-600">Â¥{report.staffShare.toLocaleString()}</td>
                                            <td className="px-6 py-4">
                                                <div className="flex flex-col items-center gap-2">
                                                    <button
                                                        onClick={() => togglePaidStatus(report.id, report.isPaid)}
                                                        className={`px-4 py-1.5 rounded-full text-xs font-medium transition-colors border shadow-sm w-full max-w-[100px] ${report.isPaid
                                                            ? 'bg-green-50 text-green-700 border-green-200 hover:bg-green-100'
                                                            : 'bg-white text-gray-600 border-gray-300 hover:bg-gray-50'
                                                            }`}
                                                    >
                                                        {report.isPaid ? 'âœ“ å…¥é‡‘æ¸ˆ' : 'æœªå…¥é‡‘'}
                                                    </button>
                                                    {!report.isPaid && (
                                                        <div className="flex flex-col items-center gap-1.5 w-full">
                                                            {report.daysPending >= 3 && (
                                                                <span className="text-[10px] text-red-600 font-bold bg-red-100 px-2 py-0.5 rounded w-full text-center">3æ—¥çµŒé!</span>
                                                            )}
                                                            <button
                                                                onClick={() => handleCopyRemind(report)}
                                                                className={`text-[10px] w-full max-w-[100px] py-1 border rounded transition-colors flex justify-center items-center ${copiedId === report.id ? 'bg-green-50 text-green-600 border-green-200' : 'border-blue-200 text-blue-600 bg-blue-50 hover:bg-blue-100'}`}
                                                            >
                                                                {copiedId === report.id ? 'âœ“ ã‚³ãƒ”ãƒ¼å®Œäº†' : 'ğŸ“ç£ä¿ƒã‚’ã‚³ãƒ”ãƒ¼'}
                                                            </button>
                                                        </div>
                                                    )}
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </section>
                </>
            )}

            {/* ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç† (æ–°è¦è¿½åŠ ãƒ»çµ¦ä¸æ˜ç´°ç­‰) */}
            {activeTab === 'staff' && (
                <section className="bg-white rounded-xl shadow-sm border overflow-hidden">
                    <div className="px-6 py-4 border-b flex justify-between items-center bg-gray-50/50">
                        <h2 className="font-semibold text-gray-800">ã‚¹ã‚¿ãƒƒãƒ•ä¸€è¦§ã¨å ±é…¬ç®¡ç† ({currentMonthStr.replace('-', 'å¹´')}æœˆ)</h2>
                        <button
                            onClick={() => alert('ã€ãƒ‡ãƒ¢ã€‘æ–°è¦ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã€ã‚¹ã‚¿ãƒƒãƒ•åã‚„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç­‰ã‚’ç™»éŒ²ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚')}
                            className="text-xs bg-gray-900 text-white px-3 py-1.5 rounded font-bold hover:bg-gray-800 transition-colors shadow-sm">
                            â• æ–°è¦ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ 
                        </button>
                    </div>
                    <div className="overflow-x-auto relative p-6">
                        <table className="w-full text-sm text-left border rounded-lg overflow-hidden">
                            <thead className="bg-gray-50 text-gray-600 border-b">
                                <tr>
                                    <th className="px-6 py-3 font-medium">ã‚¹ã‚¿ãƒƒãƒ•å</th>
                                    <th className="px-6 py-3 font-medium text-right">ä»Šæœˆã®å ±é…¬é¡</th>
                                    <th className="px-6 py-3 font-medium text-center">æ“ä½œãƒ»ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                                {staffStats.length === 0 && (
                                    <tr>
                                        <td colSpan={3} className="px-6 py-8 text-center text-gray-400">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td>
                                    </tr>
                                )}
                                {staffStats.map((s) => {
                                    return (
                                        <tr key={s.name} className="hover:bg-gray-50/50 transition-colors">
                                            <td className="px-6 py-4 font-bold text-gray-900">{s.name}</td>
                                            <td className="px-6 py-4 text-right">
                                                <div className="font-medium text-gray-900">Â¥{s.share.toLocaleString()}</div>
                                                <div className="text-[10px] text-gray-400">å£²ä¸Š: Â¥{s.sales.toLocaleString()}</div>
                                            </td>
                                            <td className="px-6 py-4">
                                                <div className="flex flex-wrap items-center justify-center gap-2">
                                                    <button
                                                        onClick={() => {
                                                            alert(`ã€çµ¦ä¸æ˜ç´° (PDFä½œæˆãƒ‡ãƒ¢)ã€‘\n\nå¯¾è±¡: ${s.name} æ§˜\nå¯¾è±¡æœˆ: ${currentMonthStr.replace('-', 'å¹´')}æœˆåˆ†\n\nãƒ»ä»Šæœˆå ±é…¬é¡: Â¥${s.share.toLocaleString()}\n\nâ†’ å®Ÿéš›ã¯ã“ã“ã§PDFãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒé–‹ãã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚`);
                                                        }}
                                                        className="px-3 py-1.5 bg-white text-gray-700 border border-gray-300 rounded text-xs font-bold hover:bg-gray-50 transition-colors">
                                                        ğŸ“„ æ˜ç´°PDFä½œæˆ
                                                    </button>
                                                    <button
                                                        onClick={() => {
                                                            alert(`ã€è‡ªå‹•ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãƒ‡ãƒ¢ã€‘\n\nå®›å…ˆ: ${s.name} æ§˜\nä»¶å: ${currentMonthStr.replace('-', 'å¹´')}æœˆåˆ† çµ¦ä¸æ˜ç´°ã®ãŠçŸ¥ã‚‰ã›\n\næœ¬æ–‡:\nã„ã¤ã‚‚ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ãƒ‡ãƒ¢å®šå‹æ–‡ã§ã™ã€‚\nä»Šæœˆã®æ˜ç´°ã‚’æ·»ä»˜ã„ãŸã—ã¾ã™...ï¼ˆé€ä¿¡å®Œäº†ï¼ï¼‰`);
                                                        }}
                                                        className="px-3 py-1.5 bg-blue-50 text-blue-600 border border-blue-200 rounded text-xs font-bold hover:bg-blue-100 transition-colors">
                                                        âœ‰ï¸ ãƒ¡ãƒ¼ãƒ«é€ä¿¡
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                </section>
            )}

            {/* ãŠå®¢æ§˜ãƒ‡ãƒã‚¸ãƒƒãƒˆç®¡ç†ã‚¿ãƒ– (ãƒ•ã‚§ãƒ¼ã‚º5ç”¨ãƒ‡ãƒ¢) */}
            {activeTab === 'deposit' && (
                <section className="bg-white rounded-xl shadow-sm border overflow-hidden">
                    <div className="px-6 py-4 border-b flex flex-wrap justify-between items-center gap-4 bg-gray-50/50">
                        <div className="flex items-center gap-4">
                            <h2 className="font-semibold text-gray-800">ãŠå®¢æ§˜ç®¡ç† (å‰æ‰•ã„ãƒ‡ãƒã‚¸ãƒƒãƒˆå«ã‚€)</h2>
                        </div>
                        <div className="flex flex-wrap items-center gap-4">
                            <div className="flex items-center gap-2">
                                <label className="text-sm text-gray-600 font-medium">ä¸¦ã¹æ›¿ãˆ:</label>
                                <select
                                    value={customerSortBy}
                                    onChange={(e) => setCustomerSortBy(e.target.value as CustomerSortOption)}
                                    className="border border-gray-300 rounded px-3 py-1.5 text-sm bg-white focus:outline-none focus:border-indigo-500 font-medium"
                                >
                                    <option value="deposit">å‰æ‰•ã„æœ‰ã‚Š (ãŠå¾—æ„æ§˜é †)</option>
                                    <option value="paid_desc">ç´¯è¨ˆæ”¯æ‰•é¡ãŒå¤šã„é †</option>
                                    <option value="registered_asc">ç™»éŒ²æ—¥ãŒå¤ã„é †</option>
                                    <option value="registered_desc">ç™»éŒ²æ—¥ãŒæ–°ã—ã„é †</option>
                                    <option value="number_asc">ãŠå®¢æ§˜ç•ªå·é †</option>
                                    <option value="name_asc">äº”åéŸ³é †</option>
                                </select>
                            </div>
                            <button
                                onClick={async () => {
                                    const name = window.prompt('æ–°ã—ã„ãŠå®¢æ§˜åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                                    if (name) {
                                        setDeposits(prev => ({ ...prev, [name]: 0 }));
                                        try {
                                            await fetch(GAS_URL, {
                                                method: 'POST',
                                                headers: { 'Content-Type': 'text/plain' },
                                                body: JSON.stringify({ action: 'addCustomer', customerName: name })
                                            });
                                        } catch (e) { console.error(e); }
                                    }
                                }}
                                className="px-3 py-1.5 bg-gray-900 text-white rounded text-sm font-bold hover:bg-gray-800 transition-colors shadow-sm">
                                ï¼‹ æ–°è¦ã®ãŠå®¢æ§˜ã‚’è¿½åŠ 
                            </button>
                        </div>
                    </div>
                    <div className="overflow-x-auto relative p-6">
                        <table className="w-full text-sm text-left border rounded-lg overflow-hidden">
                            <thead className="bg-gray-50 text-gray-600 border-b">
                                <tr>
                                    <th className="px-6 py-3 font-medium">No.</th>
                                    <th className="px-6 py-3 font-medium">ãŠå®¢æ§˜å</th>
                                    <th className="px-6 py-3 font-medium">ç™»éŒ²æ—¥</th>
                                    <th className="px-6 py-3 font-medium text-right">ç´¯è¨ˆæ”¯æ‰•é¡</th>
                                    <th className="px-6 py-3 font-medium text-right">ç¾åœ¨ã®å‰æ‰•ã„æ®‹é«˜</th>
                                    <th className="px-6 py-3 font-medium text-center">æ“ä½œãƒ»ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                                {customerList.length === 0 ? (
                                    <tr>
                                        <td colSpan={6} className="px-6 py-8 text-center text-gray-400">
                                            ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å³ä¸‹ã®ã€Œæ–°è¦ã®ãŠå®¢æ§˜ã‚’è¿½åŠ ã€ã‹ã‚‰ãŠè©¦ã—ãã ã•ã„ã€‚
                                        </td>
                                    </tr>
                                ) : (
                                    customerList.map(({ name: customerName, balance, totalPaid, registeredDate, customerNumber }) => (
                                        <tr key={customerName} className={`transition-colors ${balance > 0 ? 'bg-indigo-50/50' : 'hover:bg-gray-50/50'}`}>
                                            <td className="px-6 py-4 text-center">
                                                <span className="text-gray-400 font-medium">{customerNumber}</span>
                                            </td>
                                            <td className="px-6 py-4">
                                                <div className="flex items-center gap-2">
                                                    <span className="font-bold text-gray-900">{customerName}</span>
                                                    {balance > 0 && <span className="text-[10px] bg-indigo-100 text-indigo-700 px-1.5 py-0.5 rounded font-bold shadow-sm">âœ¨ ãŠå¾—æ„æ§˜</span>}
                                                </div>
                                            </td>
                                            <td className="px-6 py-4">
                                                <div className="text-gray-500 font-medium text-sm">
                                                    {new Date(registeredDate).toLocaleDateString('ja-JP')}
                                                </div>
                                            </td>
                                            <td className="px-6 py-4 text-right">
                                                <div className="text-gray-600 font-medium">Â¥{totalPaid.toLocaleString()}</div>
                                            </td>
                                            <td className="px-6 py-4 text-right">
                                                <div className={`font-bold ${balance > 0 ? 'text-indigo-600' : 'text-gray-400'}`}>Â¥{balance.toLocaleString()}</div>
                                            </td>
                                            <td className="px-6 py-4">
                                                <div className="flex flex-wrap items-center justify-center gap-2">
                                                    <button
                                                        onClick={async () => {
                                                            const input = window.prompt(`${customerName} æ§˜ã®è¿½åŠ å‰æ‰•ã„é¡ï¼ˆä¾‹: 5000ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`);
                                                            if (input && !isNaN(Number(input))) {
                                                                const val = Number(input);
                                                                const bonus = val >= 5000 ? Math.floor(val * 0.14) : 0;
                                                                const total = val + bonus;
                                                                const confirmed = window.confirm(`è¿½åŠ é¡: Â¥${val.toLocaleString()}\nç‰¹å…¸(14%): Â¥${bonus.toLocaleString()}\n\nåˆè¨ˆ Â¥${total.toLocaleString()} ã‚’ãƒãƒ£ãƒ¼ã‚¸ã—ã¾ã™ã‹ï¼Ÿ`);
                                                                if (confirmed) {
                                                                    setDeposits(prev => ({
                                                                        ...prev,
                                                                        [customerName]: (prev[customerName] || 0) + total
                                                                    }));
                                                                    try {
                                                                        await fetch(GAS_URL, {
                                                                            method: 'POST',
                                                                            headers: { 'Content-Type': 'text/plain' },
                                                                            body: JSON.stringify({ action: 'updateDeposit', customerName, amount: total, type: 'charge' })
                                                                        });
                                                                    } catch (e) { console.error(e); }
                                                                }
                                                            }
                                                        }}
                                                        className="px-3 py-1.5 bg-indigo-50 text-indigo-600 border border-indigo-200 rounded text-xs font-bold hover:bg-indigo-100 transition-colors">
                                                        ğŸ’° ãƒãƒ£ãƒ¼ã‚¸è¿½åŠ 
                                                    </button>
                                                    <button
                                                        onClick={async () => {
                                                            const input = window.prompt(`${customerName} æ§˜ã®ã”åˆ©ç”¨é‡‘é¡ã‚’å·®ã—å¼•ãã¾ã™ã€‚é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ï¼ˆç¾åœ¨ã®æ®‹é«˜: Â¥${balance.toLocaleString()}ï¼‰`);
                                                            if (input && !isNaN(Number(input))) {
                                                                const val = Number(input);
                                                                if (val > balance) {
                                                                    alert('æ®‹é«˜ä¸è¶³ã§ã™ã€‚');
                                                                    return;
                                                                }
                                                                const confirmed = window.confirm(`Â¥${val.toLocaleString()} ã‚’æ®‹é«˜ã‹ã‚‰å·®ã—å¼•ãã¾ã™ã‹ï¼Ÿ`);
                                                                if (confirmed) {
                                                                    setDeposits(prev => ({
                                                                        ...prev,
                                                                        [customerName]: prev[customerName] - val
                                                                    }));
                                                                    try {
                                                                        await fetch(GAS_URL, {
                                                                            method: 'POST',
                                                                            headers: { 'Content-Type': 'text/plain' },
                                                                            body: JSON.stringify({ action: 'updateDeposit', customerName, amount: -val, type: 'use' })
                                                                        });
                                                                    } catch (e) { console.error(e); }
                                                                }
                                                            }
                                                        }}
                                                        disabled={balance === 0}
                                                        className={`px-3 py-1.5 rounded text-xs font-bold transition-colors border ${balance === 0
                                                            ? 'bg-gray-100 text-gray-400 border-gray-200 cursor-not-allowed'
                                                            : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50'
                                                            }`}>
                                                        â– åˆ©ç”¨åˆ†ã‚’å¼•ã
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div>
                </section>
            )}
        </div>
    );
}

==================
'use client';

import { useState, useEffect, useRef } from 'react';
import Link from 'next/link';

interface ReportData {
    id: string;
    date: string;
    staff: string;
    customerName: string;
    totalSales: number;
    staffShare: number;
    isPaid: boolean;
}

export default function StaffMyPage() {
    const [staffName, setStaffName] = useState('');
    const [isLoggedIn, setIsLoggedIn] = useState(false);

    const [reports, setReports] = useState<ReportData[]>([]);
    const [isLoading, setIsLoading] = useState(false);
    const [errorText, setErrorText] = useState('');

    const printRef = useRef<HTMLDivElement>(null);
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzopMne7Ga8ZruWAf3xvAP7WQFvQ-Uau09qsmG2K6-Mcs7xfrXXl1Ev4GmLHpOcgTwj/exec';

    // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ï¼ˆåå‰ã‚’å…¥åŠ›ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼‰
    const handleLogin = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!staffName) return;

        setIsLoading(true);
        setErrorText('');

        try {
            const res = await fetch(`${GAS_URL}?action=getReports`);
            const json = await res.json();

            if (json.success) {
                // è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã ã‘ã‚’æŠ½å‡º
                const myData = json.data
                    .filter((row: any[]) => row[2] === staffName)
                    .map((row: any[]) => ({
                        id: row[0],
                        date: row[1],
                        staff: row[2],
                        customerName: row[4],
                        totalSales: Number(row[6]) || 0,
                        staffShare: Number(row[7]) || 0,
                        isPaid: row[8] === 'å…¥é‡‘æ¸ˆ' || row[8] === true || row[8] === 'TRUE',
                    }))
                    .sort((a: any, b: any) => new Date(b.date).getTime() - new Date(a.date).getTime());

                setReports(myData);
                setIsLoggedIn(true);
            } else {
                setErrorText('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        } catch (err) {
            console.error(err);
            setErrorText('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ã”ç¢ºèªãã ã•ã„ã€‚');
        } finally {
            setIsLoading(false);
        }
    };

    // å°åˆ·ï¼ˆPDFç”Ÿæˆï¼‰å‡¦ç†
    const handlePrint = () => {
        window.print();
    };

    // ä»Šæœˆã®è¨ˆç®—ï¼ˆâ€»æœ¬æ¥ã¯æœˆã§çµã‚Šè¾¼ã¿ã¾ã™ãŒã€ä»Šå›ã¯å…¨ä»¶ã®åˆè¨ˆã¨ã—ã¦è¡¨ç¤ºï¼‰
    const totalMyShare = reports.reduce((sum, r) => sum + r.staffShare, 0);

    // --- ãƒ­ã‚°ã‚¤ãƒ³å‰ç”»é¢ ---
    if (!isLoggedIn) {
        return (
            <div className="min-h-screen bg-gray-50/50 flex flex-col items-center pt-20 px-4">
                <div className="w-full max-w-md bg-white p-8 rounded-2xl shadow-sm border border-gray-100">
                    <h1 className="text-2xl font-bold text-gray-900 text-center mb-6">çµ¦ä¸ãƒ»æ˜ç´°ã®ç¢ºèª</h1>
                    <form onSubmit={handleLogin} className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">ã‚¹ã‚¿ãƒƒãƒ•åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</label>
                            <input
                                type="text"
                                required
                                value={staffName}
                                onChange={(e) => setStaffName(e.target.value)}
                                placeholder="ä¾‹: ãƒ†ã‚¹ãƒˆã‚¹ã‚¿ãƒƒãƒ•æ§˜"
                                className="w-full bg-gray-50 border border-gray-200 text-gray-900 rounded-xl px-4 py-3 focus:ring-2 focus:ring-[#007AFF] focus:border-transparent outline-none transition-all"
                            />
                        </div>
                        {errorText && <p className="text-red-500 text-sm">{errorText}</p>}
                        <button
                            type="submit"
                            disabled={isLoading}
                            className="w-full bg-[#007AFF] hover:bg-[#007AFF]/90 text-white font-medium py-3 rounded-xl transition-all shadow-sm flex justify-center items-center"
                        >
                            {isLoading ? 'ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªä¸­...' : 'ãƒã‚¤ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹'}
                        </button>
                    </form>
                    <div className="mt-6 text-center">
                        <Link href="/" className="text-sm text-gray-500 hover:text-gray-800 underline">
                            æ¥­å‹™å ±å‘Šãƒ•ã‚©ãƒ¼ãƒ ã¸æˆ»ã‚‹
                        </Link>
                    </div>
                </div>
            </div>
        );
    }

    // --- ãƒ­ã‚°ã‚¤ãƒ³å¾Œï¼ˆãƒã‚¤ãƒšãƒ¼ã‚¸ï¼†æ˜ç´°æ›¸ï¼‰ ---
    return (
        <div className="min-h-screen bg-gray-50/50 pt-10 pb-20 px-4 print:bg-white print:pt-0 print:pb-0">
            <div className="max-w-3xl mx-auto space-y-6">

                {/* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ï¼ˆå°åˆ·æ™‚ã¯å®Œå…¨ã«éš ã™ï¼‰ */}
                <div className="flex justify-between items-center print:hidden">
                    <Link href="/" className="text-sm text-[#007AFF] font-medium hover:underline">
                        â† å ±å‘Šãƒ•ã‚©ãƒ¼ãƒ ã«æˆ»ã‚‹
                    </Link>
                    <button
                        onClick={handlePrint}
                        className="bg-gray-900 text-white px-5 py-2 rounded-full text-sm font-medium shadow-sm hover:bg-gray-800 transition-colors"
                    >
                        ğŸ–¨ï¸ æ˜ç´°ã‚’PDFã§ä¿å­˜ãƒ»å°åˆ·
                    </button>
                </div>

                {/* --- ã“ã“ã‹ã‚‰ä¸‹ãŒã€Œæ˜ç´°æ›¸ã€ã¨ã—ã¦å°åˆ·ï¼ˆPDFåŒ–ï¼‰ã•ã‚Œã‚‹ã‚¨ãƒªã‚¢ --- */}
                <div ref={printRef} className="bg-white p-8 sm:p-12 rounded-2xl shadow-sm border border-gray-100 print:shadow-none print:border-none print:p-0">

                    <div className="flex justify-between items-start border-b pb-6 mb-8">
                        <div>
                            <h1 className="text-3xl font-extrabold text-gray-900 tracking-tight">çµ¦ä¸æ”¯æ‰•æ˜ç´°æ›¸</h1>
                            <p className="text-gray-500 mt-2">ãƒãƒŠã‚·ã‚¿ãƒ©.com</p>
                        </div>
                        <div className="text-right">
                            <p className="text-sm text-gray-500">ç™ºè¡Œæ—¥: {new Date().toLocaleDateString('ja-JP')}</p>
                            <p className="text-xl font-bold text-gray-900 mt-1">{staffName} <span className="text-sm font-normal text-gray-600">æ§˜</span></p>
                        </div>
                    </div>

                    <div className="bg-gray-50 rounded-xl p-6 mb-8 flex justify-between items-center print:border print:border-gray-200 print:bg-transparent">
                        <span className="text-lg font-medium text-gray-700">åˆè¨ˆæ”¯çµ¦é¡ï¼ˆã‚¹ã‚¿ãƒƒãƒ•å ±é…¬ï¼‰</span>
                        <span className="text-3xl font-bold text-gray-900">Â¥{totalMyShare.toLocaleString()}</span>
                    </div>

                    <h2 className="text-sm font-bold text-gray-500 mb-4 px-1">ä»Šæœˆã®æ¥­å‹™å±¥æ­´ãƒ»æ˜ç´°</h2>
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left border-collapse">
                            <thead>
                                <tr className="border-b-2 border-gray-800 text-gray-900">
                                    <th className="py-3 px-2 font-semibold">æ—¥ä»˜</th>
                                    <th className="py-3 px-2 font-semibold">ãŠå®¢æ§˜å</th>
                                    <th className="py-3 px-2 font-semibold text-right">ç·å£²ä¸Š</th>
                                    <th className="py-3 px-2 font-semibold text-right text-[#007AFF]">ã‚ãªãŸã®å ±é…¬é¡</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                                {reports.length === 0 ? (
                                    <tr>
                                        <td colSpan={4} className="py-8 text-center text-gray-400">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</td>
                                    </tr>
                                ) : (
                                    reports.map((r, i) => (
                                        <tr key={i} className="text-gray-700 print:text-black">
                                            <td className="py-4 px-2">{new Date(r.date).toLocaleDateString('ja-JP')}</td>
                                            <td className="py-4 px-2">{r.customerName}</td>
                                            <td className="py-4 px-2 text-right">Â¥{r.totalSales.toLocaleString()}</td>
                                            <td className="py-4 px-2 text-right font-bold text-gray-900">Â¥{r.staffShare.toLocaleString()}</td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div>

                    <div className="mt-16 pt-8 border-t border-gray-100 text-center text-xs text-gray-400">
                        <p>â€»æœ¬æ˜ç´°æ›¸ã¯ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
                        <p className="mt-1">ãƒãƒŠã‚·ã‚¿ãƒ©.com ã‚µãƒãƒ¼ãƒˆã‚»ãƒ³ã‚¿ãƒ¼</p>
                    </div>
                </div>
            </div>
        </div>
    );
}

==================
const SHEET_ID = '1Uzvrp-GVYFlJZht9uOawiHJS3vV3Ub6MGmsVfS0P-so';

function doPost(e) {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  
  try {
    const data = JSON.parse(e.postData.contents);
    const action = data.action;
    const output = ContentService.createTextOutput().setMimeType(ContentService.MimeType.JSON);
    
    // â‘  æ¥­å‹™å ±å‘Šã®è¿½åŠ 
    if (action === 'addReport') {
      const reportSheet = ss.getSheetByName('æ¥­å‹™å ±å‘Š');
      const depositSheet = ss.getSheetByName('å‰æ‰•ã„ç®¡ç†');
      const newId = Utilities.getUuid();
      
      let paidStatus = 'æœªå…¥é‡‘';
      let autoDeducted = false;
      let insufficientBalance = false;
      let currentDeposit = 0;
      const sales = Number(data.totalSales) || 0;
      const customerName = data.customerName;
      
      // å‰æ‰•ã„æ®‹é«˜ã‹ã‚‰è‡ªå‹•å¼•ãè½ã¨ã—
      if (depositSheet && customerName && sales > 0) {
        const dValues = depositSheet.getDataRange().getValues();
        for (let i = 1; i < dValues.length; i++) {
          if (dValues[i][0] === customerName) {
            currentDeposit = Number(dValues[i][1]) || 0;
            if (currentDeposit >= sales) {
              depositSheet.getRange(i + 1, 2).setValue(currentDeposit - sales);
              paidStatus = 'å…¥é‡‘æ¸ˆ'; 
              autoDeducted = true;
            } else if (currentDeposit > 0) {
              insufficientBalance = true;
            }
            break;
          }
        }
      }

      reportSheet.appendRow([
        newId,
        data.date,
        data.staff,
        data.customerPhone,
        data.customerName,
        data.services,
        sales,
        data.staffShare,
        paidStatus
      ]);
      
      return output.setContent(JSON.stringify({ 
        success: true, 
        id: newId, 
        autoDeducted: autoDeducted, 
        insufficientBalance: insufficientBalance,
        currentDeposit: currentDeposit
      }));
    }
    
    // â‘¡ å…¥é‡‘çŠ¶æ³ã®æ›´æ–°
    if (action === 'updatePaidStatus') {
      const sheet = ss.getSheetByName('æ¥­å‹™å ±å‘Š');
      const targetId = data.id;
      const newStatus = data.isPaid ? 'å…¥é‡‘æ¸ˆ' : 'æœªå…¥é‡‘';
      
      const values = sheet.getDataRange().getValues();
      for (let i = 1; i < values.length; i++) {
        if (values[i][0] === targetId) {
          sheet.getRange(i + 1, 9).setValue(newStatus);
          return output.setContent(JSON.stringify({ success: true }));
        }
      }
      return output.setContent(JSON.stringify({ success: false, message: 'IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' }));
    }

    // â‘¢ ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã®è¿½åŠ 
    if (action === 'addBlacklist') {
      const sheet = ss.getSheetByName('ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆ');
      // [é›»è©±ç•ªå·, ãŠå®¢æ§˜å, ç™»éŒ²ç†ç”±, ç™»éŒ²æ—¥æ™‚]
      sheet.appendRow([
        data.phone,
        data.name,
        data.reason,
        new Date().toLocaleString('ja-JP')
      ]);
      return output.setContent(JSON.stringify({ success: true }));
    }

    // â‘¤ ãŠå®¢æ§˜ã®æ–°è¦è¿½åŠ ï¼ˆå‰æ‰•ã„ç”¨ï¼‰
    if (action === 'addCustomer') {
      let sheet = ss.getSheetByName("å‰æ‰•ã„ç®¡ç†");
      if (!sheet) {
        sheet = ss.insertSheet("å‰æ‰•ã„ç®¡ç†");
        sheet.appendRow(["ãŠå®¢æ§˜å", "ç¾åœ¨ã®æ®‹é«˜"]); 
      }
      
      const customerName = data.customerName;
      const values = sheet.getDataRange().getValues();
      let exists = false;
      for (let i = 1; i < values.length; i++) {
        if (values[i][0] === customerName) {
          exists = true;
          break;
        }
      }
      
      if (!exists) {
        sheet.appendRow([customerName, 0]);
      }
      
      return output.setContent(JSON.stringify({ success: true }));
    }

    // â‘¥ ãƒãƒ£ãƒ¼ã‚¸ãƒ»åˆ©ç”¨ï¼ˆæ®‹é«˜æ›´æ–°ï¼‰
    if (action === 'updateDeposit') {
      const sheet = ss.getSheetByName("å‰æ‰•ã„ç®¡ç†");
      if (!sheet) {
        return output.setContent(JSON.stringify({ success: false, message: 'å‰æ‰•ã„ç®¡ç†ã‚·ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“' }));
      }
      
      const customerName = data.customerName;
      const amount = Number(data.amount) || 0;
      
      const values = sheet.getDataRange().getValues();
      let customerRowIndex = -1;
      let currentBalance = 0;
      
      for (let i = 1; i < values.length; i++) {
        if (values[i][0] === customerName) {
          customerRowIndex = i + 1; // 1ãƒ™ãƒ¼ã‚¹
          currentBalance = Number(values[i][1]) || 0;
          break;
        }
      }
      
      if (customerRowIndex !== -1) {
        // æ—¢å­˜é¡§å®¢ã®æ®‹é«˜ã‚’æ›´æ–°
        const newBalance = currentBalance + amount;
        sheet.getRange(customerRowIndex, 2).setValue(newBalance);
      } else {
        // é¡§å®¢ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯æ–°è¦è¿½åŠ 
        sheet.appendRow([customerName, amount]);
      }
      
      return output.setContent(JSON.stringify({ success: true }));
    }
    
    return output.setContent(JSON.stringify({ success: false, message: 'Invalid action' }));
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({ success: false, error: error.toString() })).setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  const action = e.parameter.action;
  const output = ContentService.createTextOutput().setMimeType(ContentService.MimeType.JSON);

  try {
    // æ¥­å‹™å ±å‘Šä¸€è¦§ã®å–å¾—
    if (action === 'getReports') {
      const sheet = ss.getSheetByName('æ¥­å‹™å ±å‘Š');
      const data = sheet.getDataRange().getValues();
      if (data.length > 0) data.shift(); // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’1è¡Œç›®ã¨ã—ã¦å‰Šé™¤
      return output.setContent(JSON.stringify({ success: true, data: data }));
    }

    // â‘§ é¡§å®¢æƒ…å ±ï¼ˆé›»è©±ç•ªå·â†’åå‰ã®ãƒãƒƒãƒ—ï¼‰ã¨ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã®å–å¾—
    if (action === 'getCustomerInfo') {
      const result = { success: true, customers: {}, blacklistedPhones: [] };
      
      // ã¾ãšæ¥­å‹™å ±å‘Šã‹ã‚‰é¡§å®¢ãƒãƒƒãƒ—ã‚’ä½œæˆï¼ˆæ–°ã—ã„ã‚‚ã®ãŒä¸Šæ›¸ãã•ã‚Œã‚‹ã‚ˆã†ã«ä¸Šã‹ã‚‰ä¸‹ã¸ï¼‰
      const reportSheet = ss.getSheetByName('æ¥­å‹™å ±å‘Š');
      if (reportSheet) {
        const reportData = reportSheet.getDataRange().getValues();
        if (reportData.length > 1) {
          for (let i = 1; i < reportData.length; i++) {
            const phone = String(reportData[i][3]).trim();
            const name = String(reportData[i][4]).trim();
            if (phone && name && name !== 'åç„¡ã—') {
              result.customers[phone] = name;
            }
          }
        }
      }

      // æ—¢å­˜ã®å‰æ‰•ã„ç®¡ç†ã®é¡§å®¢ã‚‚åå‰ã ã‘æ‹¾ã£ã¦ãŠãï¼ˆé›»è©±ç•ªå·ãŒãªã„ã®ã§æ¥­å‹™å ±å‘Šå„ªå…ˆï¼‰
      
      // ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆå–å¾—
      const blSheet = ss.getSheetByName('ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆ');
      if (blSheet) {
        const blData = blSheet.getDataRange().getValues();
        if (blData.length > 1) {
          for (let i = 1; i < blData.length; i++) {
            const phone = String(blData[i][0]).trim();
            if (phone) {
              result.blacklistedPhones.push(phone);
            }
          }
        }
      }

      return output.setContent(JSON.stringify(result));
    }

    // â‘¦ æ®‹é«˜ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
    if (action === 'getDeposits') {
      const sheet = ss.getSheetByName("å‰æ‰•ã„ç®¡ç†");
      if (!sheet) {
        return output.setContent(JSON.stringify({ success: false, message: 'å‰æ‰•ã„ç®¡ç†ã‚·ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“' }));
      }
      
      const data = sheet.getDataRange().getValues();
      const deposits = {};
      if (data.length > 1) { 
        for (let i = 1; i < data.length; i++) {
          const name = data[i][0];
          const balance = data[i][1];
          if (name) {
            deposits[name] = Number(balance) || 0;
          }
        }
      }
      
      return output.setContent(JSON.stringify({ success: true, deposits: deposits }));
    }
    
    return output.setContent(JSON.stringify({ success: false, message: 'Invalid action' }));
  } catch (error) {
    return output.setContent(JSON.stringify({ success: false, error: error.toString() }));
  }
}

==================
